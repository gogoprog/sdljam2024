#include "level.h"
#include <algorithm>
#include <queue>
#include <sstream>

struct Level::Pimpl {
    UnorderedMap<Vector2, UnorderedMap<Vector2, Path>> pathCache;
};

Level::Level() : pimpl(new Level::Pimpl()) {
    tilewidth = 128;
    tileheight = 128;

    reset();
}

Level::~Level() = default;

void Level::reset() {

    width = tilewidth * tileSpacing;
    height = tileheight * tileSpacing;

    buildCache();

    startCoords = {{5, 5}, {120, 120}};

    /* setLockedRoad(beginCoords); */
    /* setLockedRoad({beginCoords.x, beginCoords.y - 1}); */
    /* setLockedRoad(endCoords); */
    /* setLockedRoad({endCoords.x, endCoords.y + 1}); */

    Vector<Vector2> roads = {
        {2, -2},    {3, -2},    {4, -2},    {0, -1},    {1, -1},    {2, -1},    {4, -1},    {5, -1},    {8, -1},
        {9, -1},    {-1, 0},    {0, 0},     {1, 0},     {2, 0},     {3, 0},     {4, 0},     {5, 0},     {6, 0},
        {7, 0},     {8, 0},     {9, 0},     {10, 0},    {11, 0},    {0, 1},     {1, 1},     {2, 1},     {3, 1},
        {4, 1},     {5, 1},     {6, 1},     {7, 1},     {8, 1},     {9, 1},     {10, 1},    {11, 1},    {12, 1},
        {16, 1},    {17, 1},    {0, 2},     {1, 2},     {2, 2},     {3, 2},     {4, 2},     {5, 2},     {6, 2},
        {7, 2},     {8, 2},     {9, 2},     {10, 2},    {11, 2},    {12, 2},    {13, 2},    {14, 2},    {15, 2},
        {16, 2},    {17, 2},    {0, 3},     {1, 3},     {2, 3},     {3, 3},     {4, 3},     {5, 3},     {6, 3},
        {7, 3},     {8, 3},     {9, 3},     {10, 3},    {11, 3},    {12, 3},    {13, 3},    {14, 3},    {15, 3},
        {16, 3},    {17, 3},    {-1, 4},    {0, 4},     {1, 4},     {2, 4},     {3, 4},     {4, 4},     {5, 4},
        {6, 4},     {7, 4},     {8, 4},     {9, 4},     {10, 4},    {11, 4},    {12, 4},    {13, 4},    {14, 4},
        {15, 4},    {16, 4},    {-1, 5},    {0, 5},     {1, 5},     {2, 5},     {3, 5},     {4, 5},     {5, 5},
        {6, 5},     {7, 5},     {8, 5},     {9, 5},     {10, 5},    {11, 5},    {12, 5},    {13, 5},    {14, 5},
        {15, 5},    {16, 5},    {-1, 6},    {0, 6},     {1, 6},     {2, 6},     {3, 6},     {4, 6},     {5, 6},
        {6, 6},     {7, 6},     {8, 6},     {9, 6},     {10, 6},    {11, 6},    {12, 6},    {13, 6},    {14, 6},
        {15, 6},    {0, 7},     {1, 7},     {2, 7},     {3, 7},     {4, 7},     {5, 7},     {6, 7},     {7, 7},
        {8, 7},     {9, 7},     {10, 7},    {11, 7},    {12, 7},    {13, 7},    {14, 7},    {15, 7},    {-1, 8},
        {0, 8},     {1, 8},     {2, 8},     {3, 8},     {4, 8},     {5, 8},     {6, 8},     {7, 8},     {8, 8},
        {9, 8},     {10, 8},    {11, 8},    {12, 8},    {13, 8},    {14, 8},    {15, 8},    {-1, 9},    {0, 9},
        {1, 9},     {2, 9},     {3, 9},     {4, 9},     {5, 9},     {6, 9},     {7, 9},     {8, 9},     {9, 9},
        {10, 9},    {11, 9},    {12, 9},    {13, 9},    {0, 10},    {1, 10},    {2, 10},    {3, 10},    {4, 10},
        {5, 10},    {6, 10},    {7, 10},    {8, 10},    {9, 10},    {10, 10},   {11, 10},   {12, 10},   {13, 10},
        {0, 11},    {1, 11},    {2, 11},    {3, 11},    {4, 11},    {5, 11},    {6, 11},    {7, 11},    {8, 11},
        {9, 11},    {10, 11},   {11, 11},   {12, 11},   {13, 11},   {0, 12},    {1, 12},    {2, 12},    {3, 12},
        {4, 12},    {5, 12},    {6, 12},    {7, 12},    {8, 12},    {9, 12},    {10, 12},   {11, 12},   {12, 12},
        {13, 12},   {14, 12},   {0, 13},    {1, 13},    {2, 13},    {3, 13},    {4, 13},    {5, 13},    {6, 13},
        {7, 13},    {8, 13},    {9, 13},    {10, 13},   {11, 13},   {12, 13},   {13, 13},   {14, 13},   {0, 14},
        {1, 14},    {2, 14},    {3, 14},    {4, 14},    {5, 14},    {6, 14},    {12, 14},   {13, 14},   {14, 14},
        {15, 14},   {0, 15},    {1, 15},    {2, 15},    {3, 15},    {4, 15},    {13, 15},   {14, 15},   {15, 15},
        {0, 16},    {1, 16},    {2, 16},    {3, 16},    {4, 16},    {13, 16},   {14, 16},   {15, 16},   {0, 17},
        {1, 17},    {2, 17},    {3, 17},    {4, 17},    {5, 17},    {12, 17},   {13, 17},   {14, 17},   {15, 17},
        {16, 17},   {17, 17},   {18, 17},   {19, 17},   {20, 17},   {21, 17},   {22, 17},   {23, 17},   {24, 17},
        {25, 17},   {26, 17},   {27, 17},   {28, 17},   {29, 17},   {30, 17},   {31, 17},   {32, 17},   {0, 18},
        {1, 18},    {2, 18},    {3, 18},    {4, 18},    {5, 18},    {6, 18},    {11, 18},   {12, 18},   {13, 18},
        {14, 18},   {15, 18},   {32, 18},   {33, 18},   {34, 18},   {0, 19},    {1, 19},    {2, 19},    {3, 19},
        {4, 19},    {5, 19},    {6, 19},    {7, 19},    {8, 19},    {9, 19},    {10, 19},   {11, 19},   {12, 19},
        {13, 19},   {14, 19},   {34, 19},   {35, 19},   {0, 20},    {1, 20},    {2, 20},    {3, 20},    {4, 20},
        {5, 20},    {6, 20},    {7, 20},    {8, 20},    {9, 20},    {10, 20},   {11, 20},   {14, 20},   {35, 20},
        {36, 20},   {0, 21},    {3, 21},    {4, 21},    {10, 21},   {14, 21},   {36, 21},   {37, 21},   {14, 22},
        {37, 22},   {38, 22},   {14, 23},   {38, 23},   {14, 24},   {38, 24},   {39, 24},   {14, 25},   {39, 25},
        {40, 25},   {14, 26},   {40, 26},   {14, 27},   {40, 27},   {13, 28},   {14, 28},   {39, 28},   {40, 28},
        {12, 29},   {13, 29},   {38, 29},   {39, 29},   {12, 30},   {13, 30},   {38, 30},   {12, 31},   {13, 31},
        {37, 31},   {38, 31},   {12, 32},   {13, 32},   {14, 32},   {37, 32},   {14, 33},   {37, 33},   {14, 34},
        {31, 34},   {32, 34},   {33, 34},   {36, 34},   {37, 34},   {14, 35},   {30, 35},   {31, 35},   {32, 35},
        {33, 35},   {34, 35},   {35, 35},   {36, 35},   {14, 36},   {28, 36},   {29, 36},   {30, 36},   {31, 36},
        {32, 36},   {33, 36},   {34, 36},   {35, 36},   {36, 36},   {14, 37},   {15, 37},   {16, 37},   {26, 37},
        {27, 37},   {28, 37},   {29, 37},   {30, 37},   {31, 37},   {32, 37},   {33, 37},   {34, 37},   {35, 37},
        {36, 37},   {37, 37},   {14, 38},   {15, 38},   {16, 38},   {25, 38},   {26, 38},   {27, 38},   {28, 38},
        {29, 38},   {30, 38},   {31, 38},   {32, 38},   {33, 38},   {34, 38},   {35, 38},   {36, 38},   {37, 38},
        {15, 39},   {16, 39},   {17, 39},   {18, 39},   {19, 39},   {20, 39},   {21, 39},   {22, 39},   {23, 39},
        {24, 39},   {25, 39},   {26, 39},   {27, 39},   {28, 39},   {29, 39},   {30, 39},   {31, 39},   {32, 39},
        {33, 39},   {34, 39},   {35, 39},   {36, 39},   {37, 39},   {25, 40},   {26, 40},   {27, 40},   {28, 40},
        {29, 40},   {30, 40},   {31, 40},   {32, 40},   {33, 40},   {34, 40},   {35, 40},   {36, 40},   {37, 40},
        {26, 41},   {27, 41},   {28, 41},   {29, 41},   {30, 41},   {31, 41},   {32, 41},   {33, 41},   {34, 41},
        {35, 41},   {36, 41},   {37, 41},   {32, 42},   {33, 42},   {34, 42},   {35, 42},   {36, 42},   {37, 42},
        {37, 43},   {38, 43},   {38, 44},   {39, 44},   {39, 45},   {40, 45},   {40, 46},   {41, 47},   {41, 48},
        {41, 49},   {42, 49},   {41, 50},   {42, 50},   {41, 51},   {40, 52},   {41, 52},   {40, 53},   {40, 54},
        {40, 55},   {37, 56},   {38, 56},   {39, 56},   {40, 56},   {41, 56},   {42, 56},   {35, 57},   {36, 57},
        {37, 57},   {38, 57},   {39, 57},   {40, 57},   {41, 57},   {42, 57},   {43, 57},   {35, 58},   {36, 58},
        {37, 58},   {38, 58},   {39, 58},   {40, 58},   {41, 58},   {42, 58},   {43, 58},   {44, 58},   {35, 59},
        {36, 59},   {37, 59},   {38, 59},   {39, 59},   {40, 59},   {41, 59},   {42, 59},   {43, 59},   {44, 59},
        {34, 60},   {35, 60},   {36, 60},   {37, 60},   {38, 60},   {39, 60},   {40, 60},   {41, 60},   {42, 60},
        {43, 60},   {44, 60},   {34, 61},   {35, 61},   {36, 61},   {37, 61},   {38, 61},   {39, 61},   {40, 61},
        {41, 61},   {42, 61},   {43, 61},   {44, 61},   {34, 62},   {35, 62},   {36, 62},   {37, 62},   {38, 62},
        {39, 62},   {40, 62},   {41, 62},   {42, 62},   {43, 62},   {44, 62},   {35, 63},   {36, 63},   {37, 63},
        {38, 63},   {39, 63},   {40, 63},   {41, 63},   {42, 63},   {43, 63},   {44, 63},   {35, 64},   {36, 64},
        {37, 64},   {38, 64},   {39, 64},   {40, 64},   {41, 64},   {42, 64},   {43, 64},   {44, 64},   {36, 65},
        {37, 65},   {38, 65},   {39, 65},   {40, 65},   {41, 65},   {42, 65},   {43, 65},   {44, 65},   {37, 66},
        {38, 66},   {39, 66},   {40, 66},   {41, 66},   {42, 66},   {43, 66},   {44, 66},   {38, 67},   {39, 67},
        {40, 67},   {41, 67},   {42, 67},   {43, 67},   {44, 67},   {42, 68},   {43, 68},   {44, 68},   {45, 68},
        {43, 69},   {44, 69},   {45, 69},   {44, 70},   {45, 70},   {45, 71},   {46, 71},   {46, 72},   {46, 73},
        {47, 73},   {47, 74},   {48, 74},   {48, 75},   {49, 75},   {49, 76},   {50, 76},   {50, 77},   {51, 77},
        {51, 78},   {52, 78},   {52, 79},   {53, 79},   {54, 80},   {55, 81},   {55, 82},   {56, 82},   {56, 83},
        {57, 83},   {58, 84},   {59, 84},   {60, 84},   {61, 84},   {62, 84},   {63, 84},   {63, 85},   {64, 85},
        {65, 85},   {66, 85},   {67, 85},   {67, 86},   {68, 86},   {69, 86},   {70, 86},   {70, 87},   {71, 87},
        {72, 87},   {72, 88},   {73, 88},   {74, 88},   {74, 89},   {75, 89},   {74, 90},   {75, 90},   {76, 90},
        {77, 90},   {78, 90},   {79, 90},   {80, 90},   {81, 90},   {82, 90},   {83, 90},   {84, 90},   {85, 90},
        {86, 90},   {87, 90},   {88, 90},   {89, 90},   {90, 90},   {91, 90},   {92, 90},   {93, 90},   {94, 90},
        {95, 90},   {96, 90},   {97, 90},   {98, 90},   {73, 91},   {74, 91},   {97, 91},   {98, 91},   {73, 92},
        {97, 92},   {98, 92},   {72, 93},   {97, 93},   {98, 93},   {71, 94},   {72, 94},   {98, 94},   {70, 95},
        {71, 95},   {98, 95},   {69, 96},   {70, 96},   {98, 96},   {69, 97},   {98, 97},   {68, 98},   {69, 98},
        {98, 98},   {68, 99},   {98, 99},   {67, 100},  {68, 100},  {98, 100},  {98, 101},  {97, 102},  {98, 102},
        {99, 102},  {95, 103},  {96, 103},  {97, 103},  {98, 103},  {99, 103},  {100, 103}, {94, 104},  {95, 104},
        {96, 104},  {97, 104},  {98, 104},  {99, 104},  {100, 104}, {92, 105},  {93, 105},  {94, 105},  {95, 105},
        {96, 105},  {97, 105},  {98, 105},  {99, 105},  {100, 105}, {91, 106},  {92, 106},  {93, 106},  {94, 106},
        {95, 106},  {96, 106},  {97, 106},  {98, 106},  {99, 106},  {100, 106}, {101, 106}, {34, 107},  {90, 107},
        {91, 107},  {92, 107},  {93, 107},  {94, 107},  {95, 107},  {96, 107},  {97, 107},  {98, 107},  {99, 107},
        {100, 107}, {101, 107}, {33, 108},  {34, 108},  {89, 108},  {90, 108},  {91, 108},  {92, 108},  {93, 108},
        {94, 108},  {95, 108},  {96, 108},  {97, 108},  {98, 108},  {99, 108},  {100, 108}, {101, 108}, {33, 109},
        {34, 109},  {89, 109},  {90, 109},  {91, 109},  {92, 109},  {93, 109},  {94, 109},  {95, 109},  {96, 109},
        {97, 109},  {98, 109},  {99, 109},  {100, 109}, {101, 109}, {33, 110},  {34, 110},  {35, 110},  {89, 110},
        {90, 110},  {91, 110},  {92, 110},  {93, 110},  {94, 110},  {95, 110},  {96, 110},  {97, 110},  {98, 110},
        {99, 110},  {100, 110}, {101, 110}, {102, 110}, {103, 110}, {104, 110}, {34, 111},  {35, 111},  {36, 111},
        {37, 111},  {89, 111},  {90, 111},  {91, 111},  {92, 111},  {93, 111},  {94, 111},  {95, 111},  {96, 111},
        {97, 111},  {98, 111},  {99, 111},  {100, 111}, {101, 111}, {102, 111}, {103, 111}, {104, 111}, {105, 111},
        {106, 111}, {107, 111}, {108, 111}, {109, 111}, {126, 111}, {127, 111}, {37, 112},  {38, 112},  {63, 112},
        {64, 112},  {65, 112},  {66, 112},  {67, 112},  {68, 112},  {69, 112},  {89, 112},  {90, 112},  {91, 112},
        {92, 112},  {93, 112},  {94, 112},  {95, 112},  {96, 112},  {97, 112},  {98, 112},  {99, 112},  {100, 112},
        {101, 112}, {102, 112}, {103, 112}, {109, 112}, {110, 112}, {111, 112}, {112, 112}, {123, 112}, {124, 112},
        {125, 112}, {126, 112}, {127, 112}, {38, 113},  {39, 113},  {62, 113},  {63, 113},  {69, 113},  {70, 113},
        {71, 113},  {88, 113},  {89, 113},  {90, 113},  {91, 113},  {92, 113},  {93, 113},  {94, 113},  {95, 113},
        {96, 113},  {97, 113},  {98, 113},  {99, 113},  {100, 113}, {103, 113}, {112, 113}, {113, 113}, {114, 113},
        {122, 113}, {123, 113}, {124, 113}, {125, 113}, {126, 113}, {127, 113}, {128, 113}, {39, 114},  {40, 114},
        {61, 114},  {62, 114},  {71, 114},  {72, 114},  {87, 114},  {88, 114},  {89, 114},  {90, 114},  {91, 114},
        {92, 114},  {93, 114},  {94, 114},  {95, 114},  {96, 114},  {97, 114},  {98, 114},  {103, 114}, {114, 114},
        {115, 114}, {120, 114}, {121, 114}, {122, 114}, {123, 114}, {124, 114}, {125, 114}, {126, 114}, {127, 114},
        {128, 114}, {40, 115},  {49, 115},  {50, 115},  {51, 115},  {60, 115},  {61, 115},  {72, 115},  {85, 115},
        {86, 115},  {91, 115},  {92, 115},  {93, 115},  {94, 115},  {95, 115},  {103, 115}, {115, 115}, {116, 115},
        {117, 115}, {118, 115}, {119, 115}, {120, 115}, {121, 115}, {122, 115}, {123, 115}, {124, 115}, {125, 115},
        {126, 115}, {127, 115}, {128, 115}, {40, 116},  {47, 116},  {48, 116},  {49, 116},  {50, 116},  {51, 116},
        {59, 116},  {60, 116},  {72, 116},  {83, 116},  {84, 116},  {85, 116},  {101, 116}, {102, 116}, {103, 116},
        {115, 116}, {116, 116}, {117, 116}, {118, 116}, {119, 116}, {120, 116}, {121, 116}, {122, 116}, {123, 116},
        {124, 116}, {125, 116}, {126, 116}, {127, 116}, {128, 116}, {40, 117},  {46, 117},  {47, 117},  {50, 117},
        {51, 117},  {52, 117},  {58, 117},  {59, 117},  {72, 117},  {73, 117},  {81, 117},  {82, 117},  {83, 117},
        {101, 117}, {102, 117}, {103, 117}, {114, 117}, {115, 117}, {116, 117}, {117, 117}, {118, 117}, {119, 117},
        {120, 117}, {121, 117}, {122, 117}, {123, 117}, {124, 117}, {125, 117}, {126, 117}, {127, 117}, {128, 117},
        {40, 118},  {45, 118},  {46, 118},  {52, 118},  {53, 118},  {56, 118},  {57, 118},  {58, 118},  {73, 118},
        {74, 118},  {75, 118},  {76, 118},  {77, 118},  {78, 118},  {79, 118},  {80, 118},  {81, 118},  {101, 118},
        {102, 118}, {103, 118}, {113, 118}, {114, 118}, {115, 118}, {116, 118}, {117, 118}, {118, 118}, {119, 118},
        {120, 118}, {121, 118}, {122, 118}, {123, 118}, {124, 118}, {125, 118}, {126, 118}, {127, 118}, {128, 118},
        {40, 119},  {44, 119},  {45, 119},  {53, 119},  {54, 119},  {55, 119},  {56, 119},  {101, 119}, {102, 119},
        {103, 119}, {114, 119}, {115, 119}, {116, 119}, {117, 119}, {118, 119}, {119, 119}, {120, 119}, {121, 119},
        {122, 119}, {123, 119}, {124, 119}, {125, 119}, {126, 119}, {127, 119}, {128, 119}, {40, 120},  {41, 120},
        {42, 120},  {43, 120},  {44, 120},  {102, 120}, {103, 120}, {114, 120}, {115, 120}, {116, 120}, {117, 120},
        {118, 120}, {119, 120}, {120, 120}, {121, 120}, {122, 120}, {123, 120}, {124, 120}, {125, 120}, {126, 120},
        {127, 120}, {128, 120}, {129, 120}, {41, 121},  {42, 121},  {103, 121}, {114, 121}, {115, 121}, {116, 121},
        {117, 121}, {118, 121}, {119, 121}, {120, 121}, {121, 121}, {122, 121}, {123, 121}, {124, 121}, {125, 121},
        {126, 121}, {127, 121}, {128, 121}, {129, 121}, {130, 121}, {131, 121}, {132, 121}, {133, 121}, {103, 122},
        {104, 122}, {113, 122}, {114, 122}, {115, 122}, {116, 122}, {117, 122}, {118, 122}, {119, 122}, {120, 122},
        {121, 122}, {122, 122}, {123, 122}, {124, 122}, {125, 122}, {126, 122}, {127, 122}, {128, 122}, {132, 122},
        {133, 122}, {104, 123}, {105, 123}, {113, 123}, {114, 123}, {115, 123}, {116, 123}, {117, 123}, {118, 123},
        {119, 123}, {120, 123}, {121, 123}, {122, 123}, {123, 123}, {124, 123}, {125, 123}, {126, 123}, {127, 123},
        {128, 123}, {129, 123}, {130, 123}, {131, 123}, {132, 123}, {133, 123}, {105, 124}, {106, 124}, {107, 124},
        {113, 124}, {114, 124}, {115, 124}, {116, 124}, {117, 124}, {118, 124}, {119, 124}, {120, 124}, {121, 124},
        {122, 124}, {123, 124}, {124, 124}, {125, 124}, {126, 124}, {127, 124}, {128, 124}, {129, 124}, {130, 124},
        {131, 124}, {132, 124}, {107, 125}, {108, 125}, {112, 125}, {113, 125}, {114, 125}, {115, 125}, {116, 125},
        {117, 125}, {118, 125}, {119, 125}, {120, 125}, {121, 125}, {122, 125}, {123, 125}, {124, 125}, {125, 125},
        {126, 125}, {127, 125}, {128, 125}, {129, 125}, {130, 125}, {131, 125}, {132, 125}, {108, 126}, {109, 126},
        {110, 126}, {111, 126}, {112, 126}, {113, 126}, {114, 126}, {115, 126}, {116, 126}, {117, 126}, {118, 126},
        {119, 126}, {120, 126}, {121, 126}, {122, 126}, {123, 126}, {124, 126}, {125, 126}, {126, 126}, {127, 126},
        {128, 126}, {129, 126}, {130, 126}, {131, 126}, {110, 127}, {111, 127}, {112, 127}, {113, 127}, {114, 127},
        {115, 127}, {116, 127}, {117, 127}, {118, 127}, {119, 127}, {120, 127}, {121, 127}, {122, 127}, {123, 127},
        {124, 127}, {125, 127}, {126, 127}, {127, 127}, {128, 127}, {129, 127}, {130, 127}, {109, 128}, {110, 128},
        {111, 128}, {112, 128}, {113, 128}, {114, 128}, {115, 128}, {116, 128}, {117, 128}, {118, 128}, {119, 128},
        {120, 128}, {121, 128}, {122, 128}, {123, 128}, {124, 128}, {125, 128}, {126, 128}, {128, 128}, {129, 128},
        {111, 129}, {117, 129}, {118, 129}, {119, 129}, {124, 129}, {125, 129}, {126, 129}, {127, 129}, {128, 129},
        {116, 130}, {117, 130}};

    for (auto &r : roads) {
        setRoad(r, true);
    }
}

void Level::render(uint32_t ticks, Renderer &renderer) {
    auto &terrain = renderer.getTerrain("Snd2Watr");

    int i = 0;
    for (int y = 0; y < tileheight; ++y) {
        for (int x = 0; x < tilewidth; ++x) {
            if (cachedTypes[i] != Tile::FILL) {
                renderer.draw({x * tileSpacing, y * tileSpacing}, terrain, cachedTypes[i]);
            } else {
                static const int tiles[] = {Tile::FILL, Tile::FILL1};
                int r = (x + y + ticks / 500) % 2;

                renderer.draw({x * tileSpacing, y * tileSpacing}, terrain, tiles[r]);
            }
            ++i;
        }
    }
}

bool Level::findPath(Path &path, const Vector2 &start, const Vector2 &end) {

    {
        auto &cache = pimpl->pathCache;
        auto it = cache.find(start);

        if (it != cache.end()) {
            auto it2 = it->second.find(end);

            if (it2 != it->second.end()) {

                path = it2->second;
                return true;
            }
        }
    }

    struct Node {
        Path path;
        float distanceLeft;

        bool operator<(const Node &other) const {
            if (distanceLeft == other.distanceLeft) {
                return path.size() > other.path.size();
            }
            return distanceLeft > other.distanceLeft;
        }
    };

    std::priority_queue<Node> q;
    q.push({{start}, (start - end).getLength()});

    UnorderedMap<Vector2, int> visited;

    while (!q.empty()) {
        const auto node = q.top();
        q.pop();
        const auto last = node.path.back();

        if (visited.find(last) == visited.end() || visited[last] > node.path.size()) {
            visited[last] = node.path.size();

            if (last == end) {
                path = node.path;
                pimpl->pathCache[start][end] = path;
                return true;
                break;
            } else {
                for (auto &direction : directions) {
                    auto next = last + direction;

                    if (getRoad(next) && !locks[next]) {
                        if (std::find(node.path.begin(), node.path.end(), next) == node.path.end()) {
                            auto copy = node;
                            copy.path.push_back(next);
                            copy.distanceLeft = (next - end).getLength();
                            q.push(copy);
                        }
                    }
                }
            }
        }
    }

    return false;
}

bool Level::isFree(const Vector2 &coords) {
    return (!roadmap[coords] && !locks[coords]);
}

bool Level::canBuildAt(const Vector2 &coords) {

    if (!isFree(coords)) {
        return false;
    }
    if (!isFree({coords.x, coords.y - 1})) {
        return false;
    }
    if (!isFree({coords.x - 1, coords.y - 1})) {
        return false;
    }
    if (!isFree({coords.x - 1, coords.y})) {
        return false;
    }

    return true;
}

void Level::dump() {

    std::stringstream ss;

    ss << "Vector<Vector2> roads = { ";

    for (auto &kv : roadmap) {
        if (kv.second) {
            auto c = kv.first;
            ss << "{" << c.x << ", " << c.y << "}, ";
        }
    }

    ss.seekp(-2, std::ios_base::end);

    ss << " };\n";

    puts(ss.str().c_str());
}

void Level::buildCache() {
    cachedTypes.resize(tilewidth * tileheight);
    updateCache({0, 0}, {tilewidth - 1, tileheight - 1});
}

void Level::updateCache(const Vector2 &from, const Vector2 &to) {
    auto minx = std::max<int>(from.x, 0);
    auto maxx = std::min<int>(to.x, tilewidth - 1);
    auto miny = std::max<int>(from.y, 0);
    auto maxy = std::min<int>(to.y, tileheight - 1);

    for (int x = minx; x <= maxx; ++x) {
        for (int y = miny; y <= maxy; ++y) {
            Vector2 pos{x, y};
            int type = Tile::FILL;

            if (getRoad(pos)) {
                type = Tile::FILL2;
            } else {

                if (getRoad({x + 1, y + 1})) {
                    type = Tile::CORNER4;
                }
                if (getRoad({x - 1, y + 1})) {
                    type = Tile::CORNER3;
                }
                if (getRoad({x - 1, y - 1})) {
                    type = Tile::CORNER1;
                }
                if (getRoad({x + 1, y - 1})) {
                    type = Tile::CORNER2;
                }

                if (getRoad({x + 1, y})) {
                    type = Tile::E;

                    if (getRoad({x, y + 1})) {
                        type = Tile::SE;
                    } else if (getRoad({x, y - 1})) {
                        type = Tile::NE;
                    }
                } else if (getRoad({x - 1, y})) {
                    type = Tile::W;

                    if (getRoad({x, y + 1})) {
                        type = Tile::SW;
                    } else if (getRoad({x, y - 1})) {
                        type = Tile::NW;
                    }
                } else if (getRoad({x, y - 1})) {
                    type = Tile::N;
                } else if (getRoad({x, y + 1})) {
                    type = Tile::S;
                }
            }

            cachedTypes[y * tilewidth + x] = type;
        }
    }
}

void Level::setLockedRoad(const Vector2 &coords) {
    setRoad(coords, true);
    locks[coords] = true;
}

void Level::invalidatePathCache() {
    pimpl->pathCache.clear();
}
